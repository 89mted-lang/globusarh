<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>График занятости сотрудников</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f6f8; }
    .header { display: flex; justify-content: space-between; align-items: center; padding: 1em; background: #4285f4; color: #fff; }
    .header h1 { margin: 0; font-size: 1.5em; }
    .controls button { margin-left: .5em; padding: .5em 1em; border: none; border-radius: 4px; background: #fff; color: #4285f4; cursor: pointer; }
    .filters { display: flex; gap: 1em; padding: 1em; background: #fff; }
    .filters select, .filters input { padding: .5em; border: 1px solid #ccc; border-radius: 4px; }
    #gantt, #taskTable { margin: 1em; background: #fff; padding: 1em; border-radius: 4px; }
    #taskTable table { width: 100%; border-collapse: collapse; }
    #taskTable th, #taskTable td { border: 1px solid #e0e0e0; padding: .5em; text-align: left; }
    #taskTable th { background: #f0f0f0; }
  </style>
</head>
<body>

  <header class="header">
    <h1>График занятости сотрудников</h1>
    <div class="controls">
      <button id="btnChart">Диаграмма</button>
      <button id="btnTable">Таблица</button>
      <button id="btnBoth">Оба вида</button>
    </div>
  </header>

  <div class="filters">
    <select id="employeeFilter"><option value="">Все сотрудники</option></select>
    <select id="statusFilter">
      <option value="">Все статусы</option>
      <option value="активная">Активная</option>
      <option value="не начатая">Не начатая</option>
      <option value="завершена">Завершена</option>
      <option value="отменена">Отменена</option>
    </select>
    <input type="text" id="searchInput" placeholder="Поиск..." />
    <button id="btnSave">Сохранить</button>
  </div>

  <div id="gantt"></div>
  <div id="taskTable" style="display:none;"></div>

  <!-- Подключение Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ==== Конфигурация Firebase (замените на ваши данные) ====
    const firebaseConfig = {
      apiKey: "AIzaSyAh3B5Bouyei9OVwzs-rh04cXonGz0m5k4",
      authDomain: "globusarh.firebaseapp.com",
      databaseURL: "https://globusarh-default-rtdb.firebaseio.com",
      projectId: "globusarh",
      storageBucket: "globusarh.appspot.com",
      messagingSenderId: "370557775455 ",
      appId: "1:370557775455:web:042a439b8d6d3dadd275ea "
    };

    // Инициализация Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ==== Глобальные переменные ====
    let employees = [];
    let tasks = [];

    // ==== Загрузка задач из Firebase ====
    function loadTasks() {
      db.ref('tasks').on('value', snapshot => {
        const data = snapshot.val() || {};
        tasks = Object.values(data);
        extractEmployees();
        renderChart();
        renderTable();
      });
    }

    // ==== Сохранение задач в Firebase ====
    function saveTasks() {
      const updates = {};
      tasks.forEach(t => updates['tasks/' + t.id] = t);
      db.ref().update(updates)
        .then(() => alert('Данные сохранены'))
        .catch(console.error);
    }

    // ==== Формируем список сотрудников для фильтра ====
    function extractEmployees() {
      const names = [...new Set(tasks.map(t => t.employee))];
      employees = names.map((n, i) => ({ id: i + 1, name: n }));
      const sel = document.getElementById('employeeFilter');
      sel.innerHTML = '<option value="">Все сотрудники</option>';
      employees.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.name; opt.textContent = e.name;
        sel.append(opt);
      });
    }

    // ==== Отрисовка диаграммы Gantt ====
    function renderChart() {
      const container = document.getElementById('gantt');
      container.style.display = ''; container.innerHTML = '';
      if (!tasks.length) return;
      const w = container.clientWidth - 40;
      const minDate = new Date(Math.min(...tasks.map(t => new Date(t.start))));
      const maxDate = new Date(Math.max(...tasks.map(t => new Date(t.end))));
      const totalDays = (maxDate - minDate) / 86400000 + 1;

      employees.forEach((emp, i) => {
        const label = document.createElement('div');
        label.textContent = emp.name;
        label.style.position = 'absolute';
        label.style.top = (i * 30 + 40) + 'px';
        label.style.left = '0';
        container.append(label);
      });

      tasks.forEach(t => {
        const empIndex = employees.findIndex(e => e.name === t.employee);
        if (empIndex < 0) return;
        const sd = new Date(t.start), ed = new Date(t.end);
        const left = 40 + ((sd - minDate) / 86400000) / totalDays * w;
        const width = ((ed - sd) / 86400000) / totalDays * w;
        const bar = document.createElement('div');
        bar.textContent = t.title;
        bar.style.position = 'absolute';
        bar.style.top = (empIndex * 30 + 40) + 'px';
        bar.style.left = left + 'px';
        bar.style.width = width + 'px';
        bar.style.height = '20px';
        bar.style.background = t.type === 'Отпуск' ? '#f9a825' : '#1e88e5';
        bar.style.opacity = t.status === 'не начатая' ? '0.6' : '1';
        bar.style.color = '#fff';
        bar.style.padding = '2px';
        container.append(bar);
      });

      container.style.position = 'relative';
      container.style.height = (employees.length * 30 + 40) + 'px';
      container.style.border = '1px solid #ccc';
    }

    // ==== Отрисовка таблицы ====
    function renderTable() {
      const div = document.getElementById('taskTable');
      div.style.display = ''; div.innerHTML = '';
      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      const headers = ['Сотрудник','Тип','Название','Начало','Конец','Комментарий','Статус','Действия'];
      const trh = document.createElement('tr');
      headers.forEach(h => {
        const th = document.createElement('th'); th.textContent = h;
        trh.append(th);
      });
      thead.append(trh); tbl.append(thead);

      const tb = document.createElement('tbody');
      tasks.forEach((t, i) => {
        const tr = document.createElement('tr');
        ['employee','type','title','start','end','comment','status'].forEach(key => {
          const td = document.createElement('td');
          td.textContent = t[key];
          tr.append(td);
        });
        const tdAct = document.createElement('td');
        const btnDel = document.createElement('button');
        btnDel.textContent = 'Удалить';
        btnDel.onclick = () => {
          tasks.splice(i, 1);
          saveTasks();
        };
        tdAct.append(btnDel);
        tr.append(tdAct);
        tb.append(tr);
      });
      tbl.append(tb); div.append(tbl);
    }

    // ==== UI: переключение вида и кнопки ====
    document.getElementById('btnChart').onclick = () => {
      document.getElementById('gantt').style.display = '';
      document.getElementById('taskTable').style.display = 'none';
    };
    document.getElementById('btnTable').onclick = () => {
      document.getElementById('gantt').style.display = 'none';
      document.getElementById('taskTable').style.display = '';
    };
    document.getElementById('btnBoth').onclick = () => {
      document.getElementById('gantt').style.display = '';
      document.getElementById('taskTable').style.display = '';
    };
    document.getElementById('btnSave').onclick = saveTasks;

    // ==== Инициализация при загрузке страницы ====
    document.addEventListener('DOMContentLoaded', loadTasks);
  </script>
</body>
</html>
